<?xml version="1.0"?>
<robot name="prime" xmlns:xacro="https://www.ros.org/wiki/xacro">
  
  <xacro:arg name="namespace" default="prime"/>

  <xacro:macro name="prime_base" params="namespace">
    <!-- "Dummy base link to eliminate root link inertia warning -->
    <link name="$(arg namespace)/base_link"/>

    <!-- Start of main robot body -->
    <link name="$(arg namespace)/prime_link">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="13.0"/>
        <inertia
          ixx="0.15795" ixy="0.0" ixz="0.0"
          iyy="0.15795" iyz="0.0"
          izz="0.15795"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="file://$(find prime_description)/meshes/prime_fss.dae"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="file://$(find prime_description)/meshes/prime_fss.dae"/>
        </geometry>
      </collision>
    </link>

    <!-- Connect dummy link to main link -->
    <joint name="$(arg namespace)/prime_base_joint" type="fixed">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <parent link="$(arg namespace)/base_link"/>
      <child link="$(arg namespace)/prime_link"/>
    </joint>

    <!-- Connect base to world, fixed >
    <joint name="$(arg namespace)/world_fixed" type="fixed">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <parent link="world"/>
      <child link="$(arg namespace)/base_link"/>
    </joint-->

    <!-- Add experimental spring and bar -->
    <link name="$(arg namespace)/mass_bar">
      <inertial>
        <origin xyz="0 0.5 0.0" rpy="1.57 0 0"/>
        <mass value="0.5"/>
        <inertia
          ixx="0.0416833" ixy="0.0" ixz="0.0"
          iyy="0.0400333" iyz="0.0"
          izz="0.0416833"/>
      </inertial>
      <visual>
        <origin xyz="0 0.5 0" rpy="-1.57 0 0"/>
        <geometry>
          <mesh filename="file://$(find sc_models)/models/grab_solar_panel/meshes/grasp_panel.dae" scale="1 1 0.715"/>
          <!--box size="0.02 0.02 1.0"/-->
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0.5 0" rpy="1.57 0 0"/>
        <geometry>
          <box size="0.02 0.02 1.0"/>
        </geometry>
      </collision>
    </link>

    <joint name="$(arg namespace)/torsion_spring_joint" type="revolute">
      <origin xyz="0 0.135 0.025" rpy="0 0 0"/>
      <parent link="$(arg namespace)/prime_link"/>
      <child link="$(arg namespace)/mass_bar"/>
      <axis xyz="0 0 1"/>
      <limit effort="100000" lower="-1.57" upper="1.57" velocity="200" />
    </joint>

    <!--link name="$(arg namespace)/direction_beam">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.001"/>
        <inertia
          ixx="0.001" ixy="0.0" ixz="0.0"
          iyy="0.001" iyz="0.0"
          izz="0.001"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="0.01" length="1.0"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="0.000001" length="0.00001"/>
        </geometry>
      </collision>
    </link>

    <joint name="$(arg namespace)/direction_beam_joint" type="revolute">
      <origin xyz="0.135 0 0.025" rpy="0 1.57 0"/>
      <parent link="$(arg namespace)/prime_link"/>
      <child link="$(arg namespace)/direction_beam"/>
      <limit effort="100000" lower="0" upper="0" velocity="200" />
    </joint-->

    <gazebo>
      <plugin name="${namespace}_torsion_spring_joint" filename="libsc_torsional_spring_joint_plugin.so">
        <torsion_joint>${namespace}/torsion_spring_joint</torsion_joint>
        <kx>0.11</kx>
        <set_point>0.0</set_point>
      </plugin>
    </gazebo>

    <!-- Add air bearings -->
    <xacro:include filename="$(find prime_description)/urdf/prime_air_bearing.xacro"/>
    <xacro:add_bearing namespace="${namespace}" bearing_id="0">
      <origin xyz="0 ${0.27/2-0.05/2} ${-0.25-0.005}" rpy="0 0 0"/>
    </xacro:add_bearing>
    <xacro:add_bearing namespace="${namespace}" bearing_id="1">
      <origin xyz="${0.27/2-0.05/2} -${0.27/2-0.05/2} ${-0.25-0.005}" rpy="0 0 0"/>
    </xacro:add_bearing>
    <xacro:add_bearing namespace="${namespace}" bearing_id="2">
      <origin xyz="${-0.27/2+0.05/2} -${0.27/2-0.05/2} ${-0.25-0.005}" rpy="0 0 0"/>
    </xacro:add_bearing>

    <gazebo>
      <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
      </plugin>
    </gazebo>

    <xacro:arg name="inertial_reference_frame" default="world"/>

    <xacro:include filename="$(find sc_gazebo_plugins)/urdf/reaction_wheel.xacro"/>
    <xacro:reaction_wheel_macro namespace="$(arg namespace)" wheel_id="0">
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </xacro:reaction_wheel_macro>

    <xacro:include filename="$(find sc_gazebo_plugins)/urdf/basic_lidar.xacro"/>
    <xacro:lidar_macro
      namespace="${namespace}"
      parent_link="${namespace}/base_link"
      inertial_reference_frame="world">
    </xacro:lidar_macro>

  </xacro:macro>
</robot>
